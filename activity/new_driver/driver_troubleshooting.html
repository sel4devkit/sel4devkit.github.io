<!DOCTYPE HTML>
<html lang="en" class="ayu" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Driver Troubleshooting - seL4 Developer Kit</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="A developer kit for the seL4 microkernel on the Avnet MaaXBoard SBC (Single Board Computer).">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('ayu')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../introduction/main.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../introduction/audience.html"><strong aria-hidden="true">1.1.</strong> Audience</a></li><li class="chapter-item expanded "><a href="../../introduction/overview.html"><strong aria-hidden="true">1.2.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../introduction/structure.html"><strong aria-hidden="true">1.3.</strong> Structure</a></li></ol></li><li class="chapter-item expanded "><a href="../../resources/main.html"><strong aria-hidden="true">2.</strong> Resources</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../resources/sel4_microkernel.html"><strong aria-hidden="true">2.1.</strong> seL4 Microkernel</a></li><li class="chapter-item expanded "><a href="../../resources/avent_maaxboard.html"><strong aria-hidden="true">2.2.</strong> Avent MaaXBoard</a></li><li class="chapter-item expanded "><a href="../../resources/glossary.html"><strong aria-hidden="true">2.3.</strong> Glossary</a></li></ol></li><li class="chapter-item expanded "><a href="../../development_platform/main.html"><strong aria-hidden="true">3.</strong> Development Platform</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../development_platform/hardware_requirements.html"><strong aria-hidden="true">3.1.</strong> Hardware Requirements</a></li><li class="chapter-item expanded "><a href="../../development_platform/software_requirements.html"><strong aria-hidden="true">3.2.</strong> Software Requirements</a></li></ol></li><li class="chapter-item expanded "><a href="../../install_and_configure/main.html"><strong aria-hidden="true">4.</strong> Install and Configure</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../install_and_configure/host_setup.html"><strong aria-hidden="true">4.1.</strong> Host Setup</a></li><li class="chapter-item expanded "><a href="../../install_and_configure/build_environment_setup.html"><strong aria-hidden="true">4.2.</strong> Build Environment Setup</a></li><li class="chapter-item expanded "><a href="../../install_and_configure/target_setup.html"><strong aria-hidden="true">4.3.</strong> Target Setup</a></li><li class="chapter-item expanded "><a href="../../install_and_configure/bootloader_setup.html"><strong aria-hidden="true">4.4.</strong> Bootloader Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../install_and_configure/using_the_prebuilt_image.html"><strong aria-hidden="true">4.4.1.</strong> Using the Prebuilt Image</a></li><li class="chapter-item expanded "><a href="../../install_and_configure/building_uboot_manually.html"><strong aria-hidden="true">4.4.2.</strong> Building U-boot Manually</a></li><li class="chapter-item expanded "><a href="../../install_and_configure/configure_uboot.html"><strong aria-hidden="true">4.4.3.</strong> Setting Up the U-Boot Configuration File</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../first_boot/main.html"><strong aria-hidden="true">5.</strong> First Boot</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../first_boot/bootloader.html"><strong aria-hidden="true">5.1.</strong> Bootloader</a></li><li class="chapter-item expanded "><a href="../../first_boot/sel4test.html"><strong aria-hidden="true">5.2.</strong> seL4Test</a></li><li class="chapter-item expanded "><a href="../../first_boot/camkes_adder.html"><strong aria-hidden="true">5.3.</strong> CAmkES Adder</a></li><li class="chapter-item expanded "><a href="../../first_boot/microkit_hello_world.html"><strong aria-hidden="true">5.4.</strong> Microkit Hello World</a></li></ol></li><li class="chapter-item expanded "><a href="../../activities/main.html"><strong aria-hidden="true">6.</strong> Activities</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../activity/microkit_memory_probe/main.html"><strong aria-hidden="true">6.1.</strong> Activity: Microkit Memory Probe</a></li><li class="chapter-item expanded "><a href="../../activity/device_drivers/main.html"><strong aria-hidden="true">6.2.</strong> Activity: Device Drivers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../activity/device_drivers/uboot_driver_library.html"><strong aria-hidden="true">6.2.1.</strong> U-Boot Driver Library Overview</a></li><li class="chapter-item expanded "><a href="../../activity/device_drivers/uboot_driver_usage.html"><strong aria-hidden="true">6.2.2.</strong> Using the U-Boot Driver Library</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../activity/device_drivers/instructions_for_running_camkes.html"><strong aria-hidden="true">6.2.2.1.</strong> Instructions for running uboot-driver-example: CAmkES</a></li><li class="chapter-item expanded "><a href="../../activity/device_drivers/instructions_for_running_microkit.html"><strong aria-hidden="true">6.2.2.2.</strong> Instructions for running the uboot-driver-example: Microkit</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../activity/picoserver_uboot/main.html"><strong aria-hidden="true">6.3.</strong> Activity: Picoserver U-Boot</a></li><li class="chapter-item expanded "><a href="../../activity/new_platform/main.html"><strong aria-hidden="true">6.4.</strong> Activity: Porting Device Drivers to a New Platform</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../activity/new_platform/add_odroidc2.html"><strong aria-hidden="true">6.4.1.</strong> Add Odroid C2</a></li></ol></li><li class="chapter-item expanded "><a href="../../activity/new_driver/main.html"><strong aria-hidden="true">6.5.</strong> Activity: New Driver</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../activity/new_driver/add_driver_worked_example.html"><strong aria-hidden="true">6.5.1.</strong> Add Driver Worked Example</a></li><li class="chapter-item expanded "><a href="../../activity/new_driver/driver_troubleshooting.html" class="active"><strong aria-hidden="true">6.5.2.</strong> Driver Troubleshooting</a></li></ol></li><li class="chapter-item expanded "><a href="../../activity/guide_to_porting_seL4/main.html"><strong aria-hidden="true">6.6.</strong> Activity: Guide to Porting seL4</a></li><li class="chapter-item expanded "><a href="../../activity/spi_bus_bmp280_pressure_sensor/main.html"><strong aria-hidden="true">6.7.</strong> Activity: SPI Bus BMP280 Pressure Sensor</a></li><li class="chapter-item expanded "><a href="../../activity/camkes_case_study_application/main.html"><strong aria-hidden="true">6.8.</strong> Activity: CAmkES Case Study Application</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../activity/camkes_case_study_application/architecture.html"><strong aria-hidden="true">6.8.1.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../../activity/camkes_case_study_application/detail.html"><strong aria-hidden="true">6.8.2.</strong> Design</a></li><li class="chapter-item expanded "><a href="../../activity/camkes_case_study_application/build.html"><strong aria-hidden="true">6.8.3.</strong> Build</a></li></ol></li><li class="chapter-item expanded "><a href="../../activity/microkit_case_study_application/main.html"><strong aria-hidden="true">6.9.</strong> Activity: Microkit Case Study Application</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../activity/microkit_case_study_application/architecture.html"><strong aria-hidden="true">6.9.1.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../../activity/microkit_case_study_application/detail.html"><strong aria-hidden="true">6.9.2.</strong> Design</a></li><li class="chapter-item expanded "><a href="../../activity/microkit_case_study_application/build.html"><strong aria-hidden="true">6.9.3.</strong> Build</a></li></ol></li><li class="chapter-item expanded "><a href="../../activity/microkit_usb_driver/main.html"><strong aria-hidden="true">6.10.</strong> Activity: Microkit USB Driver</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../activity/microkit_usb_driver/adding_a_new_device.html"><strong aria-hidden="true">6.10.1.</strong> Adding a New Device</a></li><li class="chapter-item expanded "><a href="../../activity/microkit_usb_driver/common_errors.html"><strong aria-hidden="true">6.10.2.</strong> Common Errors</a></li><li class="chapter-item expanded "><a href="../../activity/microkit_usb_driver/flattened_device_tree.html"><strong aria-hidden="true">6.10.3.</strong> Flattened Device Tree</a></li><li class="chapter-item expanded "><a href="../../activity/microkit_usb_driver/memory_sharing.html"><strong aria-hidden="true">6.10.4.</strong> Memory Sharing</a></li><li class="chapter-item expanded "><a href="../../activity/microkit_usb_driver/microkit_monitor_errors.html"><strong aria-hidden="true">6.10.5.</strong> Microkit Monitor Errors</a></li><li class="chapter-item expanded "><a href="../../activity/microkit_usb_driver/extra_notes.html"><strong aria-hidden="true">6.10.6.</strong> Extra Notes</a></li></ol></li><li class="chapter-item expanded "><a href="../../activity/microkit_hdmi_driver/main.html"><strong aria-hidden="true">6.11.</strong> Activity: Microkit HDMI Driver</a></li><li class="chapter-item expanded "><a href="../../activity/microkit_vmm_single_linux_guest/main.html"><strong aria-hidden="true">6.12.</strong> Activity: Microkit VMM Single Linux Guest</a></li><li class="chapter-item expanded "><a href="../../activity/microkit_vmm_dual_linux_guest_tty_multiplex/main.html"><strong aria-hidden="true">6.13.</strong> Activity: Microkit VMM Dual Linux Guest TTY Multiplex</a></li><li class="chapter-item expanded "><a href="../../activity/microkit_vmm_dual_linux_guest_usb_routing/main.html"><strong aria-hidden="true">6.14.</strong> Activity: Microkit VMM Dual Linux Guest USB Routing</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../../licensing.html">Licensing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">seL4 Developer Kit</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/sel4devkit/sel4devkit-manual" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="library-extension---troubleshooting"><a class="header" href="#library-extension---troubleshooting">Library Extension - Troubleshooting</a></h1>
<p>This section attempts to provide guidance to help resolve issues that may be encountered when adding new device drivers to the library.</p>
<h2 id="increase-logging"><a class="header" href="#increase-logging">Increase logging</a></h2>
<p>Whenever an issue is encountered, one of the simplest actions that can be taken to provide additional data is to increase the verbosity of the library's output.</p>
<p>The library's logging level is controlled by the <code>LIB_UBOOT_LOGGING_LEVEL</code> variable in the library <code>CMakeLists.txt</code> file:</p>
<pre><code class="language-makefile">set(LIB_UBOOT_LOGGING_LEVEL "ZF_LOG_INFO")
</code></pre>
<p>This can be increased by changing the default <code>ZF_LOG_INFO</code> level to a higher logging level, e.g. <code>ZF_LOG_DEBUG</code> or <code>ZF_LOG_VERBOSE</code>.</p>
<h2 id="dma"><a class="header" href="#dma">DMA</a></h2>
<p>As documented in the <a href="../device_drivers/uboot_driver_library.html#dma">library overview</a> section, drivers utilising DMA may need manual modifications.</p>
<h3 id="detecting-dma-usage"><a class="header" href="#detecting-dma-usage">Detecting DMA usage</a></h3>
<p>When adding support for a new device and associated driver, it should be determined whether the driver utilises DMA.</p>
<p>The single most reliable method for determining DMA usage is to read and understand the device reference manual; however, there are a number of strong indicators from the U-Boot source code that can assist, such as:</p>
<ol>
<li>
<p>Search the driver source code for references to <code>DMA</code>.</p>
</li>
<li>
<p>Allocation of aligned memory (i.e. usage of <code>memalign</code>). Memory allocated with the intent of being used for DMA transfers tends to be aligned on cache line boundaries. Examples of U-Boot source code allocating memory for DMA are <code>ptr = memalign(cachline_size, ...)</code> and <code>tmp = memalign(ARCH_DMA_MINALIGN, ...)</code>.</p>
</li>
<li>
<p>Data cache flushing or invalidation (i.e. usage of <code>flush_dcache_range</code> and <code>invalidate_dcache_range</code>). Such manipulation of the data cache is a strong indicator that the associated memory is utilised for communication with a device.</p>
</li>
</ol>
<h3 id="resolving-dma-issues"><a class="header" href="#resolving-dma-issues">Resolving DMA issues</a></h3>
<p>Once it has been determined that an area of memory is being used by the driver for DMA purposes, it must be converted to use an seL4 DMA region.</p>
<p>Where the memory is managed through standard <code>malloc</code>, <code>memalign</code>, and <code>free</code>, these must be converted to the directly equivalent routines <code>sel4_dma_malloc</code>, <code>sel4_dma_memalign</code>, and <code>sel4_dma_free</code> provided by the library wrapper. Note that no changes are required to usage of <code>flush_dcache_range</code> and <code>invalidate_dcache_range</code>; these routines are automatically mapped to the seL4 DMA equivalents by the library wrapper.</p>
<p>In cases where the existing memory allocation cannot be easily modified, e.g. the memory was allocated by a variable declaration on the stack or is only used for DMA in limited cases, then an alternative approach can be taken. Prior to communicating the DMA address to the device (usually performed via memory-mapped IO) a DMA region can be allocated to mirror the original memory and the data manually copied between them as required.</p>
<p>If a driver performs conversions between the DMA region's virtual and physical addresses, such conversions must be replaced with usage of the <code>sel4_dma_virt_to_phys</code> and <code>sel4_dma_phys_to_virt</code> routines provided by the library wrapper.</p>
<h3 id="worked-examples"><a class="header" href="#worked-examples">Worked Examples</a></h3>
<p>All of the above techniques have been used in the modifications made to the Ethernet driver file <code>drivers/net/fec_mxc.c</code> in <a href="https://github.com/sel4devkit/u-boot/commit/6a4512f1d3b8427a4e192a14c52319a6228c7bbe">this Git commit</a>:</p>
<ul>
<li>Within routine <code>fec_alloc_descs</code>, calls to <code>memalign</code> have been replaced with <code>sel4_dma_memalign</code>.</li>
<li>Within routine <code>fec_free_descs</code>, the corresponding calls to <code>free</code> have been replaced with <code>sel4_dma_free</code>.</li>
<li>Within routine <code>fecmxc_send</code>, an seL4 DMA region is allocated to mirror the contents of the provided packet (and subsequently freed in <code>fecmxc_free_pkt</code>).</li>
<li>Address translations using <code>sel4_dma_virt_to_phys</code> and <code>sel4_dma_phys_to_virt</code> are performed around use of the <code>.data_pointer</code> pointers into the receive buffers (which are communicated with the device) to ensure that the device is only sent the physical address of the DMA region.</li>
</ul>
<h2 id="live-device-tree-support"><a class="header" href="#live-device-tree-support">Live Device Tree support</a></h2>
<p>As documented in the <a href="../device_drivers/uboot_driver_library.html#library-limitations">library overview</a> section, the library only supports drivers that are compatible with U-Boot's live tree format for holding the device tree.</p>
<p>Guidance on porting an old driver to the live device tree interface is provided <a href="https://u-boot.readthedocs.io/en/latest/develop/driver-model/livetree.html#porting-drivers">here</a>.</p>
<p>A worked example of porting can be seen in the Pin Multiplexing driver file <code>drivers/pinctrl/nxp/pinctrl-imx.c</code> in <a href="https://github.com/sel4devkit/u-boot/commit/6a4512f1d3b8427a4e192a14c52319a6228c7bbe">this Git commit</a>.</p>
<h2 id="missing-initialisation"><a class="header" href="#missing-initialisation">Missing Initialisation</a></h2>
<p>When a new device class has been added to the library, it may be necessary to perform explicit initialisation of the associated U-Boot subsystems. Currently this has only been required for the Ethernet and MMC device classes as shown below in the extract from <code>uboot_wrapper.c</code>:</p>
<pre><code class="language-c">int initialise_uboot_wrapper(char* fdt_blob)
{
    ...

#ifdef CONFIG_DM_MMC
    // Initialize the MMC system.
    ret = mmc_initialize(NULL);
    if (0 != ret)
        goto error;
#endif

#ifdef CONFIG_NET
    // Initialize the ethernet system.
    puts("Net:   ");
    eth_initialize();
#ifdef CONFIG_RESET_PHY_R
    debug("Reset Ethernet PHY\n");
    reset_phy();
#endif
#endif

    ...
}
</code></pre>
<p>Whether initialisation is required, and the required initialisation, can be determined by referencing U-Boot's own initialisation code held in U-Boot source file <code>common/board_r.c</code>.</p>
<h2 id="environment-variables-not-working"><a class="header" href="#environment-variables-not-working">Environment Variables Not Working</a></h2>
<p>Setting or changing certain environment variables in U-Boot can trigger callback routines. If these callback routines are not called then the setting of the environment variable will appear to have no effect.</p>
<p>Environment variable callbacks are declared by the U-Boot macro <code>U_BOOT_ENV_CALLBACK</code> and need to be referenced in the platform's <code>plat_driver_data.h</code> and <code>plat_driver_data.c</code> files, if required.</p>
<p>An example of this are the callbacks associated with networking related environment variables (e.g. setting of the IP address). The following excerpts from the Avnet MaaXBoard's <code>plat_driver_data.h</code> and <code>plat_driver_data.c</code> enable all networking related callbacks:</p>
<pre><code class="language-c">#define _u_boot_env_clbk_count 8
...
extern struct env_clbk_tbl _u_boot_env_clbk__ethaddr;
extern struct env_clbk_tbl _u_boot_env_clbk__ipaddr;
extern struct env_clbk_tbl _u_boot_env_clbk__gatewayip;
extern struct env_clbk_tbl _u_boot_env_clbk__netmask;
extern struct env_clbk_tbl _u_boot_env_clbk__serverip;
extern struct env_clbk_tbl _u_boot_env_clbk__nvlan;
extern struct env_clbk_tbl _u_boot_env_clbk__vlan;
extern struct env_clbk_tbl _u_boot_env_clbk__dnsip;
</code></pre>
<pre><code class="language-c">void initialise_driver_data(void) {
    ...
    driver_data.env_clbk_array[0] = _u_boot_env_clbk__ethaddr;
    driver_data.env_clbk_array[1] = _u_boot_env_clbk__ipaddr;
    driver_data.env_clbk_array[2] = _u_boot_env_clbk__gatewayip;
    driver_data.env_clbk_array[3] = _u_boot_env_clbk__netmask;
    driver_data.env_clbk_array[4] = _u_boot_env_clbk__serverip;
    driver_data.env_clbk_array[5] = _u_boot_env_clbk__nvlan;
    driver_data.env_clbk_array[6] = _u_boot_env_clbk__vlan;
    driver_data.env_clbk_array[7] = _u_boot_env_clbk__dnsip;
}
</code></pre>
<h2 id="incomplete-device-tree"><a class="header" href="#incomplete-device-tree">Incomplete Device Tree</a></h2>
<p>Device drivers commonly access settings stored within the platform's Device Tree. If the device does not appear to be functioning, it can be related to information missing from the Device Tree; such issues can be resolved by including the missing information in the platform's Device Tree overlay.</p>
<p>If the Device Tree is suspected of being incomplete it is suggested that the equivalent entries could be compared from Device Tree files for similar platforms (e.g. those using the same or similar SoC) held within the Linux and U-Boot repositories.</p>
<h3 id="example---dwc3-generic-usb-driver"><a class="header" href="#example---dwc3-generic-usb-driver">Example - DWC3 Generic USB Driver</a></h3>
<p>The widely used DWC3 USB device is supported by the DWC3 Generic USB driver. This driver has been found to expect a specific format of the USB device entries in the device tree with some settings held within a sub-node. Without the correct format, the USB device will not function.</p>
<p>An example of the required format is provided in the <a href="https://github.com/seL4/seL4/blob/master/src/plat/maaxboard/overlay-maaxboard.dts">overlay file for the Avnet MaaXBoard</a>.</p>
<h3 id="example---missing-pin-multiplexing-settings"><a class="header" href="#example---missing-pin-multiplexing-settings">Example - Missing Pin Multiplexing Settings</a></h3>
<p>Another potential reason for a non-functioning device is a failure to correctly configure the SoC's pin multiplexer, thereby failing to correctly connect the device to the external pins / pads on the SoC. This issue was encountered when adding SPI support for the Avnet MaaXBoard.</p>
<p>Pin multiplexing settings are held within <code>pinctrl-&lt;index&gt;</code> properties in the Device Tree, for example:</p>
<pre><code class="language-text">i2c@30a20000 {
    compatible = "fsl,imx8mq-i2c\0fsl,imx21-i2c";
    ...
    pinctrl-names = "default";
    pinctrl-0 = &lt;0x25&gt;;
</code></pre>
<p>Note that not all devices require pin multiplexer settings; e.g. device outputs may be routed to dedicated SoC pins / pads. The SoC's reference manual should be consulted to determine whether configuration is required for a device.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../activity/new_driver/add_driver_worked_example.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../activity/guide_to_porting_seL4/main.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../activity/new_driver/add_driver_worked_example.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../activity/guide_to_porting_seL4/main.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
