<!DOCTYPE HTML>
<html lang="en" class="ayu" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Library Extension - New Platform - seL4 Developer Kit</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="A developer kit for the seL4 microkernel on the Avnet MaaXBoard SBC (Single Board Computer).">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('ayu')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../introduction/main.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../introduction/audience.html"><strong aria-hidden="true">1.1.</strong> Audience</a></li><li class="chapter-item expanded "><a href="../../introduction/overview.html"><strong aria-hidden="true">1.2.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../introduction/structure.html"><strong aria-hidden="true">1.3.</strong> Structure</a></li></ol></li><li class="chapter-item expanded "><a href="../../resources/main.html"><strong aria-hidden="true">2.</strong> Resources</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../resources/sel4_microkernel.html"><strong aria-hidden="true">2.1.</strong> seL4 Microkernel</a></li><li class="chapter-item expanded "><a href="../../resources/avent_maaxboard.html"><strong aria-hidden="true">2.2.</strong> Avent MaaXBoard</a></li><li class="chapter-item expanded "><a href="../../resources/repositories.html"><strong aria-hidden="true">2.3.</strong> Repositories</a></li><li class="chapter-item expanded "><a href="../../resources/glossary.html"><strong aria-hidden="true">2.4.</strong> Glossary</a></li></ol></li><li class="chapter-item expanded "><a href="../../development_platform/main.html"><strong aria-hidden="true">3.</strong> Development Platform</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../development_platform/hardware_requirements.html"><strong aria-hidden="true">3.1.</strong> Hardware Requirements</a></li><li class="chapter-item expanded "><a href="../../development_platform/software_requirements.html"><strong aria-hidden="true">3.2.</strong> Software Requirements</a></li></ol></li><li class="chapter-item expanded "><a href="../../install_and_configure/main.html"><strong aria-hidden="true">4.</strong> Install and Configure</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../install_and_configure/host_setup.html"><strong aria-hidden="true">4.1.</strong> Host Setup</a></li><li class="chapter-item expanded "><a href="../../install_and_configure/build_environment_setup.html"><strong aria-hidden="true">4.2.</strong> Build Environment Setup</a></li><li class="chapter-item expanded "><a href="../../install_and_configure/target_setup.html"><strong aria-hidden="true">4.3.</strong> Target Setup</a></li><li class="chapter-item expanded "><a href="../../install_and_configure/bootloader_setup.html"><strong aria-hidden="true">4.4.</strong> Bootloader Setup</a></li></ol></li><li class="chapter-item expanded "><a href="../../first_boot/main.html"><strong aria-hidden="true">5.</strong> First Boot</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../first_boot/bootloader.html"><strong aria-hidden="true">5.1.</strong> Bootloader</a></li><li class="chapter-item expanded "><a href="../../first_boot/sel4test.html"><strong aria-hidden="true">5.2.</strong> seL4Test</a></li><li class="chapter-item expanded "><a href="../../first_boot/camkes_adder.html"><strong aria-hidden="true">5.3.</strong> CAmkES Adder</a></li><li class="chapter-item expanded "><a href="../../first_boot/microkit_hello_world.html"><strong aria-hidden="true">5.4.</strong> Microkit Hello World</a></li></ol></li><li class="chapter-item expanded "><a href="../../activities/main.html"><strong aria-hidden="true">6.</strong> Activities</a></li><li class="chapter-item expanded "><a href="../../activity/microkit_memory_probe/main.html"><strong aria-hidden="true">7.</strong> Activity: Microkit Memory Probe</a></li><li class="chapter-item expanded "><a href="../../activity/device_drivers/main.html"><strong aria-hidden="true">8.</strong> Activity: Device Drivers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../activity/device_drivers/uboot_driver_library.html"><strong aria-hidden="true">8.1.</strong> U-Boot Driver Library Overview</a></li><li class="chapter-item expanded "><a href="../../activity/device_drivers/uboot_driver_usage.html"><strong aria-hidden="true">8.2.</strong> Using the U-Boot Driver Library</a></li><li class="chapter-item expanded "><a href="../../activity/device_drivers/uboot_library_add_platform.html" class="active"><strong aria-hidden="true">8.3.</strong> Library Extension - New Platform</a></li><li class="chapter-item expanded "><a href="../../activity/device_drivers/uboot_library_add_driver.html"><strong aria-hidden="true">8.4.</strong> Library Extension - New Driver</a></li><li class="chapter-item expanded "><a href="../../activity/device_drivers/add_driver_worked_example.html"><strong aria-hidden="true">8.5.</strong> Add Driver Worked Example</a></li><li class="chapter-item expanded "><a href="../../activity/device_drivers/add_odroidc2.html"><strong aria-hidden="true">8.6.</strong> Add Odroid C2</a></li><li class="chapter-item expanded "><a href="../../activity/device_drivers/driver_troubleshooting.html"><strong aria-hidden="true">8.7.</strong> Driver Troubleshooting</a></li></ol></li><li class="chapter-item expanded "><a href="../../activity/spi_bus_bmp280_pressure_sensor/main.html"><strong aria-hidden="true">9.</strong> Activity: SPI Bus BMP280 Pressure Sensor</a></li><li class="chapter-item expanded "><a href="../../activity/camkes_case_study_application/main.html"><strong aria-hidden="true">10.</strong> Activity: CAmkES Case Study Application</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../activity/camkes_case_study_application/architecture.html"><strong aria-hidden="true">10.1.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../../activity/camkes_case_study_application/detail.html"><strong aria-hidden="true">10.2.</strong> Design</a></li><li class="chapter-item expanded "><a href="../../activity/camkes_case_study_application/build.html"><strong aria-hidden="true">10.3.</strong> Build</a></li></ol></li><li class="chapter-item expanded "><a href="../../activity/microkit_case_study_application/main.html"><strong aria-hidden="true">11.</strong> Activity: Microkit Case Study Application</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../activity/microkit_case_study_application/architecture.html"><strong aria-hidden="true">11.1.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../../activity/microkit_case_study_application/detail.html"><strong aria-hidden="true">11.2.</strong> Design</a></li><li class="chapter-item expanded "><a href="../../activity/microkit_case_study_application/build.html"><strong aria-hidden="true">11.3.</strong> Build</a></li></ol></li><li class="chapter-item expanded "><a href="../../activity/microkit_usb_driver/main.html"><strong aria-hidden="true">12.</strong> Activity: Microkit USB Driver</a></li><li class="chapter-item expanded "><a href="../../activity/microkit_hdmi_driver/main.html"><strong aria-hidden="true">13.</strong> Activity: Microkit HDMI Driver</a></li><li class="chapter-item expanded "><a href="../../activity/microkit_vmm_single_linux_guest/main.html"><strong aria-hidden="true">14.</strong> Activity: Microkit VMM Single Linux Guest</a></li><li class="chapter-item expanded "><a href="../../activity/microkit_vmm_dual_linux_guest_tty_multiplex/main.html"><strong aria-hidden="true">15.</strong> Activity: Microkit VMM Dual Linux Guest TTY Multiplex</a></li><li class="chapter-item expanded "><a href="../../activity/microkit_vmm_dual_linux_guest_usb_routing/main.html"><strong aria-hidden="true">16.</strong> Activity: Microkit VMM Dual Linux Guest USB Routing</a></li><li class="chapter-item expanded affix "><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../../licensing.html">Licensing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">seL4 Developer Kit</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/sel4devkit/sel4devkit-manual" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="library-extension---new-platform"><a class="header" href="#library-extension---new-platform">Library Extension - New Platform</a></h1>
<p>This section documents the required actions and guidance to add support for a new platform to the library.</p>
<p>By the end of this section, an seL4 executable will be built for the new platform that can initialise the library (although the library may not support any of the platform's devices). Later sections of this guide cover the required actions to add driver support into the library for the new platform (e.g. see the <a href="add_odroidc2.html">Odroid-C2 worked example</a>).</p>
<p>Throughout the sections of this guide devoted to extension of the U-Boot driver library, it is expected the developer is working within the folder structure created by the <code>repo</code> tool (e.g. as used to build the <a href="uboot_driver_usage.html">test applications</a>). Key folders and files within the hierarchy are shown below:</p>
<h3 id="camkes"><a class="header" href="#camkes">CAmkES</a></h3>
<pre><code class="language-text">&lt;manifest root&gt;
|
├───kernel
│   └───tools
│       └───dts
│
└───projects
    ├───camkes
    │   └───apps
    │       └───uboot-driver-example
    │           └───include
    │               └───plat
    │                   └───&lt;platform name&gt;
    │                       └───platform_devices.h
    │
    ├───projects_libs
    │   └───libubootdrivers
    │       ├───include
    │       │   └───plat
    │       │       └───&lt;platform name&gt;
    │       │           └───plat_driver_data.h
    │       ├───src
    │       │   └───plat
    │       │       └───&lt;platform name&gt;
    │       │           └───plat_driver_data.c
    │       └───CMakeLists.txt
    │
    └───uboot
</code></pre>
<ul>
<li><code>kernel/tools/dts</code>: Location of platform device trees.</li>
<li><code>projects/project_libs/camkes/apps/uboot-driver-example</code>: <a href="uboot_driver_usage.html">The test application</a>.</li>
<li><code>projects/project_libs/libubootdrivers</code>: Referred to as "the library" throughout. See <a href="https://github.com/sel4devkit/projects_libs/tree/master/libubootdrivers">linked Git repository</a>.</li>
<li><code>projects/uboot</code>: Fork of the U-Boot project source code (note, this is also symlinked to <code>projects/project_libs/libubootdrivers/uboot</code>).</li>
</ul>
<h3 id="microkit"><a class="header" href="#microkit">Microkit</a></h3>
<pre><code class="language-text">&lt;manifest root&gt;
|
└───project_libs
    ├───include
    │   └───&lt;platform&gt;
    │       └───all_platform_devices.h
    │
    ├───libubootdrivers
    │       ├───include
    │       │   └───plat
    │       │       └───&lt;platform name&gt;
    │       │           └───plat_driver_data.h
    │       ├───src
    │       │   └───plat
    │       │       └───&lt;platform name&gt;
    │       │           └───plat_driver_data.c
    │       └───CMakeLists.txt
    │
    ├───boards
    │      └───&lt;platform&gt;.dts
    │ 
    ├───example
    │   └───&lt;platform&gt;
    │       └───uboot-driver-example
    │
    └───uboot
</code></pre>
<ul>
<li><code>project_libs/boards</code>: Location of platform device trees.</li>
<li><code>example/&lt;platform&gt;/uboot-driver-example</code>: <a href="uboot_driver_usage.html">The test application</a>.</li>
<li><code>project_libs/libubootdrivers</code>: Referred to as "the library" throughout. See <a href="https://github.com/sel4-cap/dev-kit-libs/tree/main/libubootdrivers">linked Git repository</a>.</li>
<li><code>project_libs/uboot</code>: Fork of the U-Boot project source code (note, this is also symlinked to <code>microkit/libubootdrivers/uboot</code>).</li>
</ul>
<h2 id="required-reading"><a class="header" href="#required-reading">Required Reading</a></h2>
<p>The developer should be familiar with the following tools and concepts in order to add platform and driver support to the library.</p>
<ul>
<li>
<p><em>Device Tree</em>: An introduction to device tree data is <a href="https://www.kernel.org/doc/html/latest/devicetree/usage-model.html">provided by the Linux documentation</a> and by the <a href="https://docs.zephyrproject.org/2.6.0/guides/dts/intro.html">Zephyr project</a>.</p>
</li>
<li>
<p><em>CMake</em>: Reference documentation is provided by <a href="https://cmake.org/cmake/help/latest/">the CMake project</a>, including details of the structure and syntax of the CMakeLists.txt file.</p>
</li>
<li>
<p><em>CAmkES</em>: The seL4 foundation provides <a href="https://docs.sel4.systems/projects/camkes/">documentation on its use of CAmkES</a> including tutorials.</p>
</li>
<li>
<p><em>Microkit</em>: The seL4 foundation provides <a href="https://github.com/seL4/microkit/blob/main/docs/manual.md">documentation on its use of Microkit</a> including tutorials.</p>
</li>
</ul>
<h2 id="add-basic-support-to-library"><a class="header" href="#add-basic-support-to-library">Add basic support to library</a></h2>
<p>To allow the library to be successfully compiled for a new platform, the following changes will need to be made to the library.</p>
<h3 id="update-the-librarys-cmake-file-to-support-the-platform"><a class="header" href="#update-the-librarys-cmake-file-to-support-the-platform">Update the library's CMake file to support the platform</a></h3>
<p>The library's CMake file (located at <code>project_libs/libubootdrivers/CMakeLists.txt</code>) contains a section titled <code>Platform specific settings</code> to control the settings for each platform. This section:</p>
<ol>
<li>
<p>Declares a set of variables to control which drivers and optional capabilities are to be built for each platform. The default values produce a build including only a dummy timer driver; this is the minimum necessary to allow the library to be built.</p>
</li>
<li>
<p>Provides a conditional block of settings associated with each supported platform, e.g. to control which of the supported drivers to build. If no conditional block is supplied for a platform, the compilation of the library fails and an error message is returned.</p>
</li>
</ol>
<p>The minimal change to this section that allows the library to be built is therefore the inclusion of a conditional block for the platform, even if that section makes no changes to the default settings. For example, to add support for a platform that is named  <code>foo</code> within the seL4 build system, the following changes would be required:</p>
<pre><code class="language-makefile">    # Set up the applicable drivers and platform dependent configuration.
    if(KernelPlatImx8mq)
        ...
+   elseif("${KernelPlatform}" STREQUAL "foo")
+       # Platform specific settings for the Foo board.
    else()
        message(FATAL_ERROR "Unsupported platform. Aborting.")
    endif()
</code></pre>
<p>Note that where settings are shared across multiple platforms, this logic can be simplified to reflect the shared settings. An example of this is provided in the library's <code>CMakeLists.txt</code> for the <code>maaxboard</code> and <code>imx8mq-evk</code> platforms, which both use the iMX8MQ SoC.</p>
<p>It should also be noted that U-Boot drivers can support multiple devices. For example, many of the drivers added to support the Avnet MaaXBoard support multiple iMX SoCs. If previously supported drivers are compatible with the new platform, this support can be added now; for example, if platform <code>foo</code> has a GPIO device supported by the <code>gpio_mxc</code> driver (as used by the Avnet MaaXBoard), then the line <code>set(gpio_driver "gpio_mxc")</code> could be added to the <code>foo</code> platform's settings to enable support.</p>
<p>To enable access to platform specific header files it is necessary to create a symlink within the U-Boot code structure named <code>arch</code> to one of the many <code>arch-xxx</code> folders provided by U-Boot; this mimics an equivalent action taken by U-Boot's native build system. As an example it can be seen that for the iMX8MQ based platforms the <code>arch</code> symlink points to the <code>arch-imx8m</code> folder. It is expected that identification of the correct folder to link to will in most cases will be possible through naming convention alone. To definitively determine the folder to link, the symlink created during a build of U-Boot could be inspected.</p>
<h3 id="define-platform-specific-linker-lists-data-structure"><a class="header" href="#define-platform-specific-linker-lists-data-structure">Define platform specific Linker Lists data structure</a></h3>
<p>As documented within the <a href="uboot_driver_library.html#linker-lists">Linker Lists section of the library overview</a>, the library requires a global data structure named <code>driver_data</code> to be declared to allow the U-Boot source code to access optional functionality included in the executable.</p>
<p>To define <code>driver_data</code> for the new platform, new platform-specific files must be added to the library. The code blocks that follow provide minimal templates for these files that include the base device classes, drivers for those classes, and base commands that are required by all platforms.</p>
<p>File <code>include/plat/foo/plat_driver_data.h</code>:</p>
<pre><code class="language-c">/*
 * This file defines which drivers, driver classes, driver entries and commands
 * are to be included in the compiled library for this platform.
 *
 * This allows only the drivers compatible with the targeted platform to be
 * included with all non-compatible drivers excluded.
 *
 * It should be noted that some of these are fundamental to allowing the U-Boot
 * driver model to function (e.g. the nop, root and simple bus drivers).
 */

/* Define the number of different driver elements to be used on this platform */
#define _u_boot_uclass_driver_count     5
#define _u_boot_driver_count            2
#define _u_boot_usb_driver_entry_count  0
#define _u_boot_part_driver_count       0
#define _u_boot_cmd_count               3
#define _u_boot_env_driver_count        0
#define _u_boot_env_clbk_count          0
#define _u_boot_driver_info_count       0
#define _u_boot_udevice_count           0

/* Define the uclass drivers to be used on this platform. The count of declarations
 * in this section must match the value of _u_boot_uclass_driver_count */
extern struct uclass_driver _u_boot_uclass_driver__nop;
extern struct uclass_driver _u_boot_uclass_driver__root;
extern struct uclass_driver _u_boot_uclass_driver__simple_bus;
extern struct uclass_driver _u_boot_uclass_driver__phy;
extern struct uclass_driver _u_boot_uclass_driver__blk;

/* Define the drivers to be used on this platform. The count of declarations
 * in this section must match the value of _u_boot_driver_count */
extern struct driver _u_boot_driver__root_driver;
extern struct driver _u_boot_driver__simple_bus;

/* Define the driver entries to be used on this platform. The count of declarations
 * in this section must match the value of _u_boot_usb_driver_entry_count */

/* Define the disk partition types to be used. The count of declarations
 * in this section must match the value of _u_boot_part_driver_count */

/* Define the u-boot commands to be used on this platform. The count of declarations
 * in this section must match the value of _u_boot_cmd_count */
extern struct cmd_tbl _u_boot_cmd__dm;
extern struct cmd_tbl _u_boot_cmd__env;
extern struct cmd_tbl _u_boot_cmd__setenv;

/* Define the u-boot environment variables callbacks to be used on this platform. The
 * count of declarations in this section must match the value of _u_boot_env_clbk_count */
</code></pre>
<p>File <code>src/plat/foo/plat_driver_data.c</code>:</p>
<pre><code class="language-c">#include &lt;uboot_helper.h&gt;
#include &lt;driver_data.h&gt;

#include &lt;dm/device.h&gt;
#include &lt;dm/uclass.h&gt;
#include &lt;dm/platdata.h&gt;
#include &lt;usb.h&gt;
#include &lt;part.h&gt;

void initialise_driver_data(void) {
    /* The number of elements in the uclass_driver_array must match the
     * _u_boot_uclass_driver_count constant (see plat_driver_data.h) */
    driver_data.uclass_driver_array[0]  = _u_boot_uclass_driver__nop;
    driver_data.uclass_driver_array[1]  = _u_boot_uclass_driver__root;
    driver_data.uclass_driver_array[2]  = _u_boot_uclass_driver__simple_bus;
    driver_data.uclass_driver_array[3]  = _u_boot_uclass_driver__phy;
    driver_data.uclass_driver_array[4]  = _u_boot_uclass_driver__blk;

    /* The number of elements in the driver_array must match the
     * _u_boot_driver_count constant (see plat_driver_data.h) */
    driver_data.driver_array[0]  = _u_boot_driver__root_driver;
    driver_data.driver_array[1]  = _u_boot_driver__simple_bus;

    /* The number of elements in the cmd_array must match the
     * _u_boot_cmd_count constant (see plat_driver_data.h) */
    driver_data.cmd_array[0]  = _u_boot_cmd__dm;
    driver_data.cmd_array[1]  = _u_boot_cmd__env;
    driver_data.cmd_array[2]  = _u_boot_cmd__setenv;
}
</code></pre>
<p>As support for additional optional objects (e.g. drivers, driver classes, commands, etc.) are added for a platform, these files will be updated to reference the associated objects. See the files for the Avnet MaaXBoard platform for an example of these how these files provide more extensive support.</p>
<h2 id="add-support-to-example-application"><a class="header" href="#add-support-to-example-application">Add support to example application</a></h2>
<p>Section <a href="uboot_driver_usage.html">Using the U-Boot Driver Library</a> introduced the demonstration application  <code>uboot-driver-example</code>. This section documents the changes required to the <code>uboot-driver-example</code> application to allow it to be built for the new platform.</p>
<p>The following empty template file needs to be added to the application <code>include/plat/foo/platform_devices.h</code>:</p>
<h3 id="camkes-1"><a class="header" href="#camkes-1">CAmkES</a></h3>
<pre><code class="language-c">#pragma once

/* List the set of device tree paths that include the 'reg' entries
 * for memory regions that will need to be mapped */
#define REG_PATHS {};
#define REG_PATH_COUNT 0

/* List the set of device tree paths for the devices we wish to access.
 * Note these need to be the root nodes of each device to be accessed */
#define DEV_PATHS {};
#define DEV_PATH_COUNT 0

/* Provide the hardware settings for CAmkES. Note that we only need to inform
 * CAmkES of the devices with memory mapped regions, i.e. the REG_xxx
 * devices. See https://docs.sel4.systems/projects/camkes for syntax */

#define HARDWARE_INTERFACES

#define HARDWARE_COMPOSITION

#define HARDWARE_CONFIGURATION
</code></pre>
<h3 id="microkit-1"><a class="header" href="#microkit-1">Microkit</a></h3>
<pre><code class="language-c">#pragma once

/* List the set of device tree paths that include the 'reg' entries
 * for memory regions that will need to be mapped */
#define REG_PATHS {};
#define REG_PATH_COUNT 0

/* List the set of device tree paths for the devices we wish to access.
 * Note these need to be the root nodes of each device to be accessed */
#define DEV_PATHS {};
#define DEV_PATH_COUNT 0
</code></pre>
<p>As support for devices is added for a platform, this file will be updated to reference those devices from the platform's device tree. See the file for the Avnet MaaXBoard platform for an example that provides more extensive support.</p>
<h2 id="guidance-on-next-steps"><a class="header" href="#guidance-on-next-steps">Guidance on next steps</a></h2>
<p>At this point, the library should compile cleanly for the new platform but will fail during library initialisation due to no devices being supplied.</p>
<p>The order in which drivers need to be added is likely to depend on the intended usage of the library; e.g. support for a single device or support for multiple devices, and the internal needs of the device drivers to be added.</p>
<p>The following drivers are likely to form the core of the support for a platform and underpin the capabilities of other drivers. It may be possible to support some devices without these core drivers, but that would need to checked on a case-by-case basis.</p>
<h3 id="timer"><a class="header" href="#timer">Timer</a></h3>
<p>As documented <a href="uboot_driver_library.html#timer">in the library overview</a>, some U-Boot drivers rely upon access to a monotonic timer to underpin their timing needs.</p>
<p>By default a platform will be supported by the <code>dummy</code> timer driver (see library file <code>src/timer/timer_dummy.c</code>). Whilst the dummy timer driver allows the library to build cleanly, it will raise an assertion error / exception, thereby halting execution, should any of the timing routines be used. Some simple drivers (e.g. GPIO drivers) typically do not require any timing routines and so can be supported without the need to provide a functional timer; however, a functional timer will typically need to be provided to support more complex devices such as Ethernet or USB.</p>
<p>The means of providing a timer driver is architecture- and platform-dependent, so detailed guidance cannot be provided. A worked example of a timer driver for the iMX8MQ SoC is provided in file <code>src/timer/timer_imx8mq.c</code>; it is expected that this driver could be extended to cover multiple iMX SoCs.</p>
<h3 id="clock"><a class="header" href="#clock">Clock</a></h3>
<p>The U-Boot <code>CLK</code> subsystem is used to enable and reconfigure clocks. To enable the <code>CLK</code> subsystem, support for the platform's U-Boot clock driver will need to be added. See the configuration of the clock driver for the Avnet MaaXBoard in the library's <code>CMakeLists.txt</code> file as an example.</p>
<p>In many cases it may be possible to support devices without the need to add support for a clock driver. Simple devices, e.g. GPIO, may not use a clock source. Even for more complex devices that use a clock source, it may be possible for the device to function without providing a clock driver; e.g. if the device was previously set up and used by the bootloader prior to entry to seL4 then it is likely that the required clocks have already been configured and enabled.</p>
<h3 id="pin-multiplexing-iomux"><a class="header" href="#pin-multiplexing-iomux">Pin Multiplexing (IOMUX)</a></h3>
<p>SoCs typically contain a lot of functionality but a have limited number of pins (or pads). Pin multiplexing is used to configure pins for a specific purpose. An IOMUX driver must be supplied to allow the library to configure the pins from the default configuration.</p>
<p>As with the clock driver, in many cases it may be possible to support devices without the need to add support for an IOMUX driver. For example, if a device was previously set up and used by the bootloader prior to entry to seL4 then it is likely that the required pin configuration has already been configured.</p>
<h3 id="gpio"><a class="header" href="#gpio">GPIO</a></h3>
<p>Many drivers rely upon the availability of a GPIO driver to function correctly. For example: an MMC driver may use GPIO for card-detect and write-protect sensing; an Ethernet driver may use GPIO to reset an external PHY; an SPI driver may use GPIO for the chip select signal, etc.</p>
<p>As such it may be necessary to provide a GPIO driver for other drivers to function correctly.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../activity/device_drivers/uboot_driver_usage.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../activity/device_drivers/uboot_library_add_driver.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../activity/device_drivers/uboot_driver_usage.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../activity/device_drivers/uboot_library_add_driver.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
